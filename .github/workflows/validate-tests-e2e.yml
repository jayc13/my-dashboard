name: 'Validate Tests E2E'

permissions:
  contents: read

on:
  workflow_call:

jobs:
  validate-tests-e2e:
    name: Validate E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup validation environment
        uses: ./.github/actions/setup-validation

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies for tests/e2e-tests..."
          pnpm install --filter=tests/e2e-tests

      - name: Run linting
        run: |
          echo "ğŸ” Running linting on tests/e2e-tests..."
          pnpm run lint --filter=tests/e2e-tests || echo "âš ï¸ No linting configured for tests/e2e-tests"

      - name: Run type checking
        run: |
          echo "ğŸ” Running TypeScript type checking..."
          pnpm run type-check --filter=tests/e2e-tests

      - name: Validate test structure
        run: |
          echo "ğŸ” Validating E2E test structure..."
          cd tests/e2e-tests
          
          # Check for test files
          if [ ! -d "tests" ] && [ ! -d "src" ] && [ ! -f "*.spec.ts" ] && [ ! -f "*.spec.js" ] && [ ! -f "*.test.ts" ] && [ ! -f "*.test.js" ]; then
            echo "âŒ No E2E test files found"
            exit 1
          fi
          
          echo "âœ… E2E test structure validated"

      - name: Check Playwright configuration
        run: |
          echo "ğŸ” Checking Playwright configuration..."
          cd tests/e2e-tests
          
          if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
            echo "âœ… Playwright configuration found"
          else
            echo "âš ï¸ No Playwright configuration found"
          fi

      - name: Install Playwright browsers (headless)
        run: |
          echo "ğŸ­ Installing Playwright browsers for validation..."
          cd tests/e2e-tests
          
          # Install only chromium for validation (faster)
          if command -v playwright &> /dev/null; then
            npx playwright install chromium --with-deps
          elif pnpm exec playwright --version &> /dev/null; then
            pnpm exec playwright install chromium --with-deps
          else
            echo "âš ï¸ Playwright not found, skipping browser installation"
          fi

      - name: Validate test syntax
        run: |
          echo "ğŸ” Validating test syntax..."
          cd tests/e2e-tests
          
          # Try to parse test files without running them
          if command -v playwright &> /dev/null; then
            npx playwright test --list > /dev/null 2>&1 && echo "âœ… Test syntax validated" || echo "âš ï¸ Test syntax validation skipped"
          elif pnpm exec playwright --version &> /dev/null; then
            pnpm exec playwright test --list > /dev/null 2>&1 && echo "âœ… Test syntax validated" || echo "âš ï¸ Test syntax validation skipped"
          else
            echo "âš ï¸ Playwright not available for syntax validation"
          fi

      - name: Check test dependencies
        run: |
          echo "ğŸ” Checking test dependencies..."
          cd tests/e2e-tests
          
          # Verify package.json has required dependencies
          if [ -f "package.json" ]; then
            echo "ğŸ“¦ Package.json found"
            if grep -q "playwright\|@playwright" package.json; then
              echo "âœ… Playwright dependency found"
            else
              echo "âš ï¸ Playwright dependency not found in package.json"
            fi
          else
            echo "âŒ Package.json not found"
            exit 1
          fi
