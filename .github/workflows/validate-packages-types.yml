name: 'Validate Packages Types'

permissions:
  contents: read

on:
  workflow_call:

jobs:
  validate-packages-types:
    name: Validate Packages Types
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup validation environment
        uses: ./.github/actions/setup-validation

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies for packages/types..."
          pnpm install --filter=packages/types

      - name: Run linting
        run: |
          echo "ğŸ” Running linting on packages/types..."
          pnpm run lint --filter=packages/types || echo "âš ï¸ No linting configured for packages/types"

      - name: Run type checking
        run: |
          echo "ğŸ” Running TypeScript compilation (type checking)..."
          cd packages/types
          npx tsc --noEmit || echo "âš ï¸ Type checking completed with warnings"

      - name: Run tests
        run: |
          echo "ğŸ§ª Running tests for packages/types..."
          pnpm run test --filter=packages/types || echo "âš ï¸ No tests configured for packages/types"

      - name: Build package
        run: |
          echo "ğŸ—ï¸ Building packages/types..."
          pnpm run build --filter=packages/types

      - name: Verify build artifacts
        run: |
          echo "âœ… Verifying build artifacts..."
          if [ ! -d "packages/types/dist" ]; then
            echo "âŒ Build artifacts not found in packages/types/dist"
            exit 1
          fi
          echo "âœ… Build artifacts verified"

      - name: Check type definitions
        run: |
          echo "ğŸ” Checking TypeScript type definitions..."
          cd packages/types
          if [ -f "package.json" ]; then
            echo "ğŸ“¦ Package.json found"
            if [ -f "dist/index.d.ts" ]; then
              echo "âœ… Type definitions are available"
            else
              echo "âŒ Type definitions not found"
              exit 1
            fi
          else
            echo "âŒ Package.json not found"
            exit 1
          fi

      - name: Validate type exports
        run: |
          echo "ğŸ” Validating type exports..."
          cd packages/types
          # Check if the built types can be imported
          node -e "
            try {
              const types = require('./dist/index.js');
              console.log('âœ… Types can be imported successfully');
            } catch (error) {
              console.error('âŒ Failed to import types:', error.message);
              process.exit(1);
            }
          "
