name: 'Validate Packages SDK'

permissions:
  contents: read

on:
  workflow_call:

jobs:
  validate-packages-sdk:
    name: Validate Packages SDK
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup validation environment
        uses: ./.github/actions/setup-validation

      - name: Install dependencies
        run: |
          echo "📦 Installing dependencies for packages/sdk..."
          pnpm install --filter=@my-dashboard/sdk

      - name: Build packages/types (dependency)
        run: |
          echo "🏗️ Building packages/types (required dependency)..."
          pnpm --filter=@my-dashboard/types run build

      - name: Run linting
        run: |
          echo "🔍 Running linting on packages/sdk..."
          pnpm --filter=@my-dashboard/sdk run lint || echo "⚠️ No linting configured for packages/sdk"

      - name: Run type checking
        run: |
          echo "🔍 Running TypeScript compilation (type checking)..."
          cd packages/sdk
          npx tsc --noEmit || echo "⚠️ Type checking completed with warnings"

      - name: Run tests
        run: |
          echo "🧪 Running tests for packages/sdk..."
          pnpm --filter=@my-dashboard/sdk run test || echo "⚠️ No tests configured for packages/sdk"

      - name: Build package
        run: |
          echo "🏗️ Building packages/sdk..."
          pnpm --filter=@my-dashboard/sdk run build

      - name: Verify build artifacts
        run: |
          echo "✅ Verifying build artifacts..."
          if [ ! -d "packages/sdk/dist" ]; then
            echo "❌ Build artifacts not found in packages/sdk/dist"
            exit 1
          fi
          echo "✅ Build artifacts verified"

      - name: Check package exports
        run: |
          echo "🔍 Checking package exports..."
          cd packages/sdk
          if [ -f "package.json" ]; then
            echo "📦 Package.json found"
            if [ -f "dist/index.js" ] || [ -f "dist/index.d.ts" ]; then
              echo "✅ Package exports are available"
            else
              echo "❌ Package exports not found"
              exit 1
            fi
          else
            echo "❌ Package.json not found"
            exit 1
          fi
