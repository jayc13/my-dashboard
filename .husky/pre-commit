#!/usr/bin/env sh

export HNVM_PNPM=10.17.1

# =============================================================================
# Pre-commit Hook
# =============================================================================
# This script runs before each commit to ensure code quality and consistency.
# It performs linting, auto-fixing, and building for all workspace packages.
# =============================================================================

echo "üîç Running pre-commit checks..."

# Navigate to the git repository root
cd "$(git rev-parse --show-toplevel)" || exit 1

# =============================================================================
# Load nvm and set Node.js version
# =============================================================================
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm

nvm use 22.20.0

# =============================================================================
# Install Dependencies
# =============================================================================
echo "üì¶ Installing dependencies to ensure everything is up to date..."
pnpm install --registry=https://registry.npmjs.org/

# =============================================================================
# Run Quality Checks Across All Workspaces
# =============================================================================

# Step 1: Run linting across all workspaces (excluding root)
echo ""
echo "üìù Running linting across all workspaces..."
echo "----------------------------------------"
pnpm -r --if-present run lint

# Step 2: Run type checking across all workspaces (excluding root)
echo ""
echo "üîç Running type checking across all workspaces..."
echo "----------------------------------------"
pnpm -r --if-present run typecheck

# Step 3: Run build across all workspaces (excluding root)
echo ""
echo "üèóÔ∏è  Running build across all workspaces..."
echo "----------------------------------------"
pnpm -r --if-present run build

if [ $? -eq 0 ]; then
  echo "‚úÖ Build passed for all workspaces!"
else
  echo "‚ùå Build failed! Please fix the issues before committing."
  exit 1
fi

echo ""
echo "üéâ All pre-commit checks completed successfully!"
echo "Your code is ready to commit! üöÄ"
