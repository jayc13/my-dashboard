#!/usr/bin/env sh

# =============================================================================
# Pre-commit Hook
# =============================================================================
# This script runs before each commit to ensure code quality and consistency.
# It performs linting, auto-fixing, and building for all workspace packages.
# =============================================================================

echo "🔍 Running pre-commit checks..."

# Navigate to the git repository root
cd "$(git rev-parse --show-toplevel)" || exit 1

# =============================================================================
# Install Dependencies
# =============================================================================
echo "📦 Installing dependencies to ensure everything is up to date..."
npx pnpm install

# =============================================================================
# Run Quality Checks Across All Workspaces
# =============================================================================

# Step 1: Run linting across all workspaces (excluding root)
echo ""
echo "📝 Running linting across all workspaces..."
echo "----------------------------------------"
npx pnpm -r --if-present run lint

if [ $? -eq 0 ]; then
  echo "✅ Linting passed! Running auto-fix..."
  npx pnpm -r --if-present run lint-fix
else
  echo "❌ Linting failed! Please fix the issues before committing."
  exit 1
fi

# Step 2: Run build across all workspaces (excluding root)
echo ""
echo "🏗️  Running build across all workspaces..."
echo "----------------------------------------"
npx pnpm -r --if-present run build

if [ $? -eq 0 ]; then
  echo "✅ Build passed for all workspaces!"
else
  echo "❌ Build failed! Please fix the issues before committing."
  exit 1
fi

echo ""
echo "🎉 All pre-commit checks completed successfully!"
echo "Your code is ready to commit! 🚀"
