#!/usr/bin/env sh

# =============================================================================
# Pre-commit Hook
# =============================================================================
# This script runs before each commit to ensure code quality and consistency.
# It performs linting, auto-fixing, and building for all workspace packages.
# =============================================================================

echo "ğŸ” Running pre-commit checks..."

# Navigate to the git repository root
cd "$(git rev-parse --show-toplevel)" || exit 1

# =============================================================================
# Install Dependencies
# =============================================================================
echo "ğŸ“¦ Installing dependencies to ensure everything is up to date..."
npm install --registry=https://registry.npmjs.org/

# =============================================================================
# Define Workspace Directories
# =============================================================================
# List of all workspace directories that need to be processed
# Each directory on its own line for easy modification
DIRS="packages/types \
packages/sdk \
client \
server \
cron \
mock-server \
scripts"

# =============================================================================
# Process Each Workspace Directory
# =============================================================================
for dir in $DIRS; do
  echo ""
  echo "ğŸ”„ Processing workspace: $dir"
  echo "----------------------------------------"

  # Step 1: Run linting
  echo "ğŸ“ Running linting in $dir..."
  npm run lint --workspace=$dir

  if [ $? -eq 0 ]; then
    echo "âœ… Linting passed in $dir! Running auto-fix..."
    npm run lint-fix --workspace=$dir
  else
    echo "âŒ Linting failed in $dir! Please fix the issues before committing."
    exit 1
  fi

  # Step 2: Run build
  echo "ğŸ—ï¸  Running build in $dir..."
  npm run build --workspace=$dir

  if [ $? -eq 0 ]; then
    echo "âœ… Build passed in $dir!"
  else
    echo "âŒ Build failed in $dir! Please fix the issues before committing."
    exit 1
  fi
done

echo ""
echo "ğŸ‰ All pre-commit checks completed successfully!"
echo "Your code is ready to commit! ğŸš€"
